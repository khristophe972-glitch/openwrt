name: Build MT6000 OpenWrt

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-24.04
    steps:
      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
          sudo apt-get clean
          df -h

      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y build-essential clang flex bison g++ gawk \
          gcc-multilib g++-multilib gettext git libncurses-dev libssl-dev \
          python3-setuptools rsync swig unzip zlib1g-dev file wget llvm

      - name: Clone sources
        run: |
          git clone --branch next-r4.7.2.rss.mtk --single-branch https://github.com/${{ github.repository }}.git openwrt
          cd openwrt
          git log --oneline -5

      - name: Update feeds
        run: |
          cd openwrt
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Import config
        run: |
          cd openwrt
          wget https://raw.githubusercontent.com/pesa1234/MT6000_cust_build/refs/heads/main/2025-04-19_r29721-5111451803_next-r4.5.34.rss.mtk/targets/mediatek/filogic/config.buildinfo -O .config
          echo "CONFIG_PACKAGE_kmod-nft-fullcone=y" >> .config
          make defconfig

      - name: Download packages
        run: |
          cd openwrt
          make download -j$(nproc)

      - name: Build firmware
        run: |
          cd openwrt
          make -j$(nproc) || make -j1 V=s

      - name: Find firmware files
        run: |
          find openwrt/bin/ -name "*.bin" -o -name "*.img" -o -name "*.ko" | head -30

      - name: Upload firmware
        uses: actions/upload-artifact@v4
        with:
          name: mt6000-firmware
          path: openwrt/bin/
