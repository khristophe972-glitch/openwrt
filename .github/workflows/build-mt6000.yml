name: Build MT6000 OpenWrt

on:
  workflow_dispatch:

permissions:
  contents: write
  pages: write

jobs:
  build:
    runs-on: ubuntu-24.04
    steps:
      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
          sudo apt-get clean
          df -h

      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y build-essential clang flex bison g++ gawk \
          gcc-multilib g++-multilib gettext git libncurses-dev libssl-dev \
          python3-setuptools rsync swig unzip zlib1g-dev file wget llvm

      - name: Clone sources
        run: |
          git clone --branch next-r4.7.2.rss.mtk --single-branch https://github.com/${{ github.repository }}.git openwrt
          cd openwrt
          git log --oneline -5

      - name: Update feeds
        run: |
          cd openwrt
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Apply turboacc fullcone patches
        run: |
          cd openwrt
          curl -sSL https://raw.githubusercontent.com/chenmozhijin/turboacc/luci/add_turboacc.sh -o add_turboacc.sh
          bash add_turboacc.sh --no-sfe

      - name: Import config
        run: |
          cd openwrt
          wget https://raw.githubusercontent.com/pesa1234/MT6000_cust_build/refs/heads/main/2025-04-19_r29721-5111451803_next-r4.5.34.rss.mtk/targets/mediatek/filogic/config.buildinfo -O .config
          echo "CONFIG_PACKAGE_kmod-nft-fullcone=y" >> .config
          echo "CONFIG_PACKAGE_luci-app-turboacc=y" >> .config
          echo "CONFIG_PACKAGE_kmod-sched=y" >> .config
          echo "CONFIG_PACKAGE_kmod-sched-cake=y" >> .config
          echo "CONFIG_PACKAGE_kmod-sched-core=y" >> .config
          echo "CONFIG_PACKAGE_kmod-sched-prio=y" >> .config
          echo "CONFIG_PACKAGE_kmod-sched-bpf=y" >> .config
          echo "CONFIG_PACKAGE_kmod-sched-flower=y" >> .config
          echo "CONFIG_PACKAGE_kmod-sched-act-vlan=y" >> .config
          echo "CONFIG_PACKAGE_sqm-scripts=y" >> .config
          echo "CONFIG_PACKAGE_luci-app-sqm=y" >> .config
          echo "CONFIG_PACKAGE_tc-full=y" >> .config
          echo "CONFIG_PACKAGE_iptables-nft=y" >> .config
          echo "CONFIG_PACKAGE_iptables-mod-ipopt=y" >> .config
          echo "CONFIG_PACKAGE_iptables-mod-conntrack-extra=y" >> .config
          echo "CONFIG_PACKAGE_iptables-mod-extra=y" >> .config
          echo "CONFIG_PACKAGE_iptables-mod-filter=y" >> .config
          echo "CONFIG_PACKAGE_ip6tables-nft=y" >> .config
          echo "CONFIG_PACKAGE_miniupnpd-nftables=y" >> .config
          echo "CONFIG_PACKAGE_luci-app-upnp=y" >> .config
          echo "CONFIG_PACKAGE_tcpdump=y" >> .config
          echo "CONFIG_PACKAGE_iperf3=y" >> .config
          echo "CONFIG_PACKAGE_curl=y" >> .config
          echo "CONFIG_PACKAGE_bind-dig=y" >> .config
          echo "CONFIG_PACKAGE_mtr=y" >> .config
          echo "CONFIG_PACKAGE_ethtool-full=y" >> .config
          echo "CONFIG_PACKAGE_irqbalance=y" >> .config
          echo "CONFIG_PACKAGE_luci-app-statistics=y" >> .config
          echo "CONFIG_PACKAGE_luci-app-nlbwmon=y" >> .config
          echo "CONFIG_ALL_KMODS=y" >> .config
          make defconfig

      - name: Download packages
        run: |
          cd openwrt
          make download -j$(nproc)

      - name: Build firmware
        run: |
          cd openwrt
          make -j$(nproc) || make -j1 V=s

      - name: Prepare package repository
        run: |
          cd openwrt
          mkdir -p /tmp/pkg-repo/targets/mediatek/filogic/packages
          mkdir -p /tmp/pkg-repo/packages/aarch64_cortex-a53
          cp -a bin/targets/mediatek/filogic/packages/* /tmp/pkg-repo/targets/mediatek/filogic/packages/ 2>/dev/null || true
          for feed in base luci packages routing telephony video; do
            if [ -d "bin/packages/aarch64_cortex-a53/$feed" ]; then
              mkdir -p /tmp/pkg-repo/packages/aarch64_cortex-a53/$feed
              cp -a bin/packages/aarch64_cortex-a53/$feed/* /tmp/pkg-repo/packages/aarch64_cortex-a53/$feed/ 2>/dev/null || true
            fi
          done
          mkdir -p /tmp/pkg-repo/firmware
          cp bin/targets/mediatek/filogic/*sysupgrade* /tmp/pkg-repo/firmware/ 2>/dev/null || true
          cp bin/targets/mediatek/filogic/*factory* /tmp/pkg-repo/firmware/ 2>/dev/null || true
          cp bin/targets/mediatek/filogic/sha256sums /tmp/pkg-repo/firmware/ 2>/dev/null || true
          echo "=== Package counts ==="
          find /tmp/pkg-repo -name "*.apk" | wc -l
          echo "=== Total size ==="
          du -sh /tmp/pkg-repo/

      - name: Deploy to gh-pages branch
        run: |
          cd /tmp/pkg-repo
          git init
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git checkout -b gh-pages
          git add .
          git commit -m "Package repo update $(date -u +%Y-%m-%d_%H%M%S)"
          git remote add origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
          git push -f origin gh-pages

      - name: Upload firmware artifact
        uses: actions/upload-artifact@v4
        with:
          name: mt6000-firmware
          path: openwrt/bin/targets/mediatek/filogic/*

      - name: Upload all packages artifact
        uses: actions/upload-artifact@v4
        with:
          name: mt6000-packages-all
          path: /tmp/pkg-repo/
