name: Build MT6000 OpenWrt

on:
  workflow_dispatch:

permissions:
  contents: write
  pages: write

jobs:
  build:
    runs-on: ubuntu-24.04
    steps:
      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
          sudo apt-get clean
          df -h

      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y build-essential clang flex bison g++ gawk \
          gcc-multilib g++-multilib gettext git libncurses-dev libssl-dev \
          python3-setuptools rsync swig unzip zlib1g-dev file wget llvm

      - name: Clone sources
        run: |
          git clone --branch next-r4.7.2.rss.mtk --single-branch https://github.com/${{ github.repository }}.git openwrt
          cd openwrt
          git log --oneline -5

      - name: Update feeds
        run: |
          cd openwrt
          for i in 1 2 3; do
            ./scripts/feeds update -a && break
            echo "Retry $i..."
            sleep 30
          done
          ./scripts/feeds install -a

      - name: Apply turboacc fullcone patches
        run: |
          cd openwrt
          curl -sSL https://raw.githubusercontent.com/chenmozhijin/turboacc/luci/add_turboacc.sh -o add_turboacc.sh
          bash add_turboacc.sh --no-sfe

      - name: Import config
        run: |
          cd openwrt
          wget https://raw.githubusercontent.com/pesa1234/MT6000_cust_build/refs/heads/main/2025-04-19_r29721-5111451803_next-r4.5.34.rss.mtk/targets/mediatek/filogic/config.buildinfo -O .config
          echo "CONFIG_PACKAGE_kmod-nft-fullcone=y" >> .config
          echo "CONFIG_PACKAGE_luci-app-turboacc=y" >> .config
          echo "CONFIG_PACKAGE_kmod-sched=y" >> .config
          echo "CONFIG_PACKAGE_kmod-sched-cake=y" >> .config
          echo "CONFIG_PACKAGE_kmod-sched-core=y" >> .config
          echo "CONFIG_PACKAGE_kmod-sched-prio=y" >> .config
          echo "CONFIG_PACKAGE_kmod-sched-bpf=y" >> .config
          echo "CONFIG_PACKAGE_kmod-sched-flower=y" >> .config
          echo "CONFIG_PACKAGE_kmod-sched-act-vlan=y" >> .config
          echo "CONFIG_PACKAGE_sqm-scripts=y" >> .config
          echo "CONFIG_PACKAGE_luci-app-sqm=y" >> .config
          echo "CONFIG_PACKAGE_tc-full=y" >> .config
          echo "CONFIG_PACKAGE_iptables-nft=y" >> .config
          echo "CONFIG_PACKAGE_iptables-mod-ipopt=y" >> .config
          echo "CONFIG_PACKAGE_iptables-mod-conntrack-extra=y" >> .config
          echo "CONFIG_PACKAGE_iptables-mod-extra=y" >> .config
          echo "CONFIG_PACKAGE_iptables-mod-filter=y" >> .config
          echo "CONFIG_PACKAGE_ip6tables-nft=y" >> .config
          echo "CONFIG_PACKAGE_miniupnpd-nftables=y" >> .config
          echo "CONFIG_PACKAGE_luci-app-upnp=y" >> .config
          echo "CONFIG_PACKAGE_tcpdump=y" >> .config
          echo "CONFIG_PACKAGE_iperf3=y" >> .config
          echo "CONFIG_PACKAGE_curl=y" >> .config
          echo "CONFIG_PACKAGE_bind-dig=y" >> .config
          echo "CONFIG_PACKAGE_mtr=y" >> .config
          echo "CONFIG_PACKAGE_ethtool-full=y" >> .config
          echo "CONFIG_PACKAGE_irqbalance=y" >> .config
          echo "CONFIG_PACKAGE_luci-app-statistics=y" >> .config
          echo "CONFIG_PACKAGE_luci-app-nlbwmon=y" >> .config
          echo "CONFIG_ALL_KMODS=y" >> .config
          make defconfig

      - name: Download packages
        run: |
          cd openwrt
          make download -j$(nproc)

      - name: Build firmware
        run: |
          cd openwrt
          make -j$(nproc) || make -j1 V=s

      - name: Debug build outputs
        if: always()
        run: |
          cd openwrt
          echo "=== Directory structure ==="
          find bin/ -maxdepth 4 -type d 2>/dev/null
          echo "=== APK files count ==="
          find bin/ -name "*.apk" 2>/dev/null | wc -l
          echo "=== IPK files count ==="
          find bin/ -name "*.ipk" 2>/dev/null | wc -l
          echo "=== Package index files ==="
          find bin/ -name "packages.adb" -o -name "Packages" -o -name "Packages.gz" -o -name "APKINDEX*" 2>/dev/null
          echo "=== Firmware files ==="
          find bin/ -name "*sysupgrade*" -o -name "*factory*" 2>/dev/null
          echo "=== Sample package files ==="
          find bin/ -name "*.apk" -o -name "*.ipk" 2>/dev/null | head -20
          echo "=== bin/ total size ==="
          du -sh bin/

      - name: Prepare package repository
        if: always()
        run: |
          cd openwrt
          mkdir -p /tmp/pkg-repo
          # Copier TOUT bin/ tel quel
          cp -a bin/* /tmp/pkg-repo/ 2>/dev/null || true
          echo "=== Package repo contents ==="
          find /tmp/pkg-repo -name "*.apk" -o -name "*.ipk" 2>/dev/null | wc -l
          du -sh /tmp/pkg-repo/

      - name: Deploy to gh-pages branch
        if: always()
        run: |
          cd /tmp/pkg-repo
          FILE_COUNT=$(find . -type f | wc -l)
          echo "Files to deploy: $FILE_COUNT"
          if [ "$FILE_COUNT" -gt 0 ]; then
            git init
            git config user.name "GitHub Actions"
            git config user.email "actions@github.com"
            git checkout -b gh-pages
            git add .
            git commit -m "Package repo update $(date -u +%Y-%m-%d_%H%M%S)"
            git remote add origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
            git push -f origin gh-pages
            echo "Deployed $FILE_COUNT files to gh-pages"
          else
            echo "WARNING: No files found to deploy"
          fi

      - name: Upload firmware artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: mt6000-firmware
          path: openwrt/bin/targets/mediatek/filogic/

      - name: Upload packages artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: mt6000-packages
          path: openwrt/bin/packages/
